name: ğŸ“Š Novi's Enhanced Daily Intelligence Report (PDF Version)

on:
  schedule:
    # Runs at 11:30 PM UTC (5:00 AM IST next day)
    - cron: '30 23 * * *'
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-and-send-enhanced-pdf-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install System Dependencies for WeasyPrint
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev \
          python3-pip \
          python3-cffi \
          python3-brotli \
          libpango-1.0-0 \
          libharfbuzz0b \
          libpangoft2-1.0-0 \
          libfontconfig1-dev \
          libcairo2-dev \
          libgdk-pixbuf2.0-dev
          
    - name: ğŸ“§ Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Check Python Syntax
      run: |
        echo "ğŸ” Checking syntax of all Python files..."
        python -m py_compile src/data_collectors/jobs_collector.py
        python -m py_compile src/data_collectors/stock_collector.py  
        python -m py_compile src/data_collectors/sap_collector.py
        python -m py_compile src/data_collectors/news_collector.py
        python -m py_compile src/utils/email_sender.py
        python -m py_compile src/utils/pdf_generator.py
        python -m py_compile src/report_generator.py
        python -m py_compile config.py
        echo "âœ… Syntax check passed for all files"
        
    - name: ğŸ• Set Timezone to IST
      run: |
        sudo timedatectl set-timezone Asia/Kolkata
        echo "Current time: $(date)"
        
    - name: ğŸ“ Create Required Directories
      run: |
        mkdir -p reports
        mkdir -p src/templates
        mkdir -p logs
        echo "âœ… Directories created"
        
    - name: ğŸ”§ Validate Configuration
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        python -c "
        import os
        from src.utils.email_sender import EmailSender
        sender = EmailSender()
        issues = sender.validate_configuration()
        if issues:
            print('âŒ Configuration Issues:')
            for issue in issues:
                print(f'  - {issue}')
            exit(1)
        else:
            print('âœ… Email configuration validated successfully')
        "
        
    - name: ğŸ§ª Test Email Configuration (if test mode)
      if: ${{ github.event.inputs.test_mode == 'true' }}
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        python -c "
        from src.utils.email_sender import EmailSender
        sender = EmailSender()
        success = sender.send_test_email()
        if success:
            print('âœ… Test email sent successfully')
        else:
            print('âŒ Test email failed')
            exit(1)
        "
        
    - name: ğŸ“Š Generate and Send Enhanced PDF Report
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        echo "ğŸš€ Starting Enhanced PDF report generation..."
        python src/report_generator.py
        echo "ğŸ“§ Enhanced PDF report generation completed"
        
    - name: ğŸ“‚ Archive Enhanced PDF Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: novi-enhanced-intelligence-report-pdf
        path: reports/*.pdf
        retention-days: 30
        
    - name: ğŸ“ Log Completion
      if: success()
      run: |
        echo "âœ… Enhanced PDF Report generated and sent successfully at $(date)"
        echo "ğŸ“Š Next report scheduled for tomorrow at 5:00 AM IST"  
        echo "ğŸ“„ Report archived as GitHub Actions artifact"
        echo "ğŸ”§ Includes: SAP jobs, AI transition jobs, enhanced stock analysis, AI insights"
        
    - name: ğŸš¨ Handle Errors
      if: failure()
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        echo "âŒ Enhanced PDF report generation failed"
        echo "ğŸ“§ Sending error notification..."
        python -c "
        import os
        import traceback
        from src.utils.email_sender import EmailSender
        try:
            sender = EmailSender()
            error_msg = 'GitHub Actions workflow failed during Enhanced PDF generation. Check the Actions logs for details.'
            sender.send_error_notification(error_msg, 'Enhanced PDF Report Generation Failure')
            print('ğŸ“§ Error notification sent')
        except Exception as e:
            print(f'Failed to send error notification: {e}')
        "
        
    - name: ğŸ“ˆ Upload Logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-logs-enhanced-pdf
        path: |
          *.log
          /tmp/*.log
          reports/
          logs/
        retention-days: 7
