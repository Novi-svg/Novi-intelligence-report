name: 📊 Novi's Daily Intelligence Report

on:
  schedule:
    # Runs at 11:30 PM UTC (5:00 AM IST next day)
    - cron: '30 23 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-and-send-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📧 Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 🔍 Check Python Syntax
      run: |
        echo "🔍 Checking syntax of all Python files..."
        python -m py_compile src/data_collectors/jobs_collector.py
        python -m py_compile src/utils/email_sender.py
        python -m py_compile src/report_generator.py
        echo "✅ Syntax check passed for all files"
        
    - name: 🕐 Set Timezone to IST
      run: |
        sudo timedatectl set-timezone Asia/Kolkata
        echo "Current time: $(date)"
        
    - name: 🔧 Validate Configuration
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        python -c "
        import os
        from src.utils.email_sender import EmailSender
        
        sender = EmailSender()
        issues = sender.validate_configuration()
        
        if issues:
            print('❌ Configuration Issues:')
            for issue in issues:
                print(f'  - {issue}')
            exit(1)
        else:
            print('✅ Email configuration validated successfully')
        "
    
    - name: 🧪 Test Email Configuration (if test mode)
      if: ${{ github.event.inputs.test_mode == 'true' }}
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        python -c "
        from src.utils.email_sender import EmailSender
        
        sender = EmailSender()
        success = sender.send_test_email()
        
        if success:
            print('✅ Test email sent successfully')
        else:
            print('❌ Test email failed')
            exit(1)
        "
        
    - name: 📊 Generate and Send Report
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        # Optional: Add these if you want to use any APIs in the future
        # NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        # ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
        # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "🚀 Starting report generation..."
        python src/report_generator.py
        echo "📧 Report generation completed"
        
    - name: 📝 Log Completion
      if: success()
      run: |
        echo "✅ Report generated and sent successfully at $(date)"
        echo "📊 Next report scheduled for tomorrow at 5:00 AM IST"
        
    - name: 🚨 Handle Errors
      if: failure()
      env:
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
      run: |
        echo "❌ Report generation failed"
        echo "📧 Sending error notification..."
        
        python -c "
        import os
        import traceback
        from src.utils.email_sender import EmailSender
        
        try:
            sender = EmailSender()
            error_msg = 'GitHub Actions workflow failed. Check the Actions logs for details.'
            sender.send_error_notification(error_msg, 'Workflow Failure')
            print('📧 Error notification sent')
        except Exception as e:
            print(f'Failed to send error notification: {e}')
        "
        
    - name: 📈 Upload Logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-logs
        path: |
          *.log
          /tmp/*.log
        retention-days: 7
